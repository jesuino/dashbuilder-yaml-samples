properties:
  ### User properties (you can modify this)
  prom_url: http://localhost:9090
  refresh: -1
  
  period: 10m
  window: 10s

  # parameters
  coal: 2.23
  petroleum: 2.13
  natural_gas: 0.91
  
  namespace: ".*"

  # 1W*s = 1J and 1J = (1/3600000)kWh
  watt_per_second_to_kWh: 0.000000277777777777778

  cache: true
  mode: dark
  
  ### Internal Properties
  time_window: "[${period}:${window}]"
  dataset_url: ${prom_url}/api/v1/query

global:
  mode: ${mode}
  allowUrlProperties: true
  dataset:
    url: ${dataset_url}
    type: prometheus
    cacheEnabled: ${cache}
  settings:
    chart:
      grid:
        y: false
    refresh:
        interval: ${refresh}
    meter:
      critical: "8"
      warning: "5"
      start: "0"
      end: "10"
datasets:
  # Gauges Datasets
  - uuid: co2Coal
    query:
        query: >-
            (sum(
                (increase(kepler_container_package_joules_total[1h])
                 *${watt_per_second_to_kWh}
                ) *
               (count_over_time(kepler_container_package_joules_total[24h])/
                  count_over_time(kepler_container_package_joules_total[1h])
               )
              ) * ${coal}
            )
            +
            (sum(
                (increase(kepler_container_dram_joules_total[1h])
                 *${watt_per_second_to_kWh}
                ) *
               (count_over_time(kepler_container_dram_joules_total[24h])/
                  count_over_time(kepler_container_dram_joules_total[1h])
               )
              ) * ${coal}
            )
  - uuid: co2Petroleum
    query:
        query: >-
            (sum(
                (increase(kepler_container_package_joules_total[1h])
                 *${watt_per_second_to_kWh}
                ) *
               (count_over_time(kepler_container_package_joules_total[24h])/
                  count_over_time(kepler_container_package_joules_total[1h])
               )
              ) * ${petroleum}
            )
            +
            (sum(
                (increase(kepler_container_dram_joules_total[1h])
                 *${watt_per_second_to_kWh}
                ) *
               (count_over_time(kepler_container_dram_joules_total[24h])/
                  count_over_time(kepler_container_dram_joules_total[1h])
               )
              ) * ${petroleum}
            )
  - uuid: co2NaturalGas
    query:
      query: >-
        (sum(
            (increase(kepler_container_package_joules_total[1h])
             *${watt_per_second_to_kWh}
            ) *
           (count_over_time(kepler_container_package_joules_total[24h])/
              count_over_time(kepler_container_package_joules_total[1h])
           )
          ) * ${natural_gas}
        )
        +
        (sum(
            (increase(kepler_container_dram_joules_total[1h])
             *${watt_per_second_to_kWh}
            ) *
           (count_over_time(kepler_container_dram_joules_total[24h])/
              count_over_time(kepler_container_dram_joules_total[1h])
           )
          ) * ${natural_gas}
        )
  # Total PowerConsumption Bar Chart
  - uuid: totalPowerConsumption
    query:
      query: >-
        sum by (container_namespace) (
              (increase(kepler_container_package_joules_total[1h])
                *${watt_per_second_to_kWh}
              ) *
              (count_over_time(kepler_container_package_joules_total[24h])/
                count_over_time(kepler_container_package_joules_total[1h])
              )
              
            )
            +
            sum by (container_namespace) (
              (increase(kepler_container_dram_joules_total[1h])
                *${watt_per_second_to_kWh}
              ) *
              (count_over_time(kepler_container_dram_joules_total[24h])/
                count_over_time(kepler_container_dram_joules_total[1h])
              )
            )
  # Total Power Consumption By Day
  - uuid: PKG by Day
    query:
      query: >-
        sum(
          (increase(kepler_container_package_joules_total[1h])
            *${watt_per_second_to_kWh}
          ) *
          (count_over_time(kepler_container_package_joules_total[24h])/
            count_over_time(kepler_container_package_joules_total[1h])
          )
        )${time_window}
  - uuid: DRAM by Day
    query:
      query: >-
        sum(
          (increase(kepler_container_dram_joules_total[1h])
            *${watt_per_second_to_kWh}
          ) *
          (count_over_time(kepler_container_dram_joules_total[24h])/
            count_over_time(kepler_container_dram_joules_total[1h])
          )
        )${time_window}
  - uuid: Other by Day
    query:
      query: >-
        sum(
          (increase(
            kepler_container_other_host_components_joules_total[1h])
            *${watt_per_second_to_kWh}
          ) *
          (count_over_time(
            kepler_container_other_host_components_joules_total[24h])/
            count_over_time(
              kepler_container_other_host_components_joules_total[1h])
          )
        )${time_window}
  - uuid: GPU by Day
    query:
      query: >-
        sum(
          (increase(kepler_container_gpu_joules_total[1h])
            *${watt_per_second_to_kWh}
          ) *
          (count_over_time(kepler_container_gpu_joules_total[24h])/
            count_over_time(kepler_container_gpu_joules_total[1h])
          )
        )${time_window}
  - uuid: powerConsumptionByDay
    join:
      - PKG by Day
      - DRAM by Day
      - Other by Day
      - GPU by Day
  # Total Power Consumption (W)
  - uuid: PKG (W)
    query:
      query: sum(irate(kepler_container_package_joules_total[1m]))${time_window}
  - uuid: DRAM (W)
    query:
      query: sum(irate(kepler_container_dram_joules_total[1m]))${time_window}
  - uuid: OTHER (W)
    query:
      query: sum(irate(kepler_container_other_host_components_joules_total[1m]))${time_window}
  - uuid: GPU (W)
    query:
      query: sum(irate(kepler_container_gpu_joules_total[1m]))${time_window}
  - uuid: totalPowerConsumptionW
    join:
      - PKG (W)
      - DRAM (W)
      - OTHER (W)
      - GPU (W)
  # Power By
  - uuid: packagesPowerConsumption
    query:
      query: >-
        sum by (pod_name) (irate(kepler_container_package_joules_total[1m]))${time_window}
  - uuid: dramPowerConsumption
    query:
      query: >-
        sum by (pod_name) (irate(kepler_container_dram_joules_total[1m]))${time_window}
  - uuid: otherPowerConsumption
    query:
      query: >-
        sum by (pod_name) (irate(kepler_container_other_host_joules_total[1m]))${time_window}
  - uuid: gpuPowerConsumption
    query:
      query: >-
        sum by (pod_name) (irate(kepler_container_gpu_joules_total[1m]))${time_window}
  - uuid: byPowerConsumption
    expression: >-
        $.[
            $[0], 
            $[2], 
            $[3] = "packagesPowerConsumption" ? $[1] : "0",
            $[3] = "dramPowerConsumption" ? $[1] : "0",
            $[3] = "otherPowerConsumption" ? $[1] : "0",
            $[3] = "gpuPowerConsumption" ? $[1] : "0"
        ]
    join:
      - packagesPowerConsumption
      - dramPowerConsumption
      - otherPowerConsumption
      - gpuPowerConsumption
    columns:
        - id: timestamp
        - id: Pod Name
        - id: PKG
        - id: DRAM
        - id: OTHER
        - id: GPU
        
    ## Aux queries
  - uuid: namespaces
    query:
        query: sum by (container_namespace) (kepler_container_package_joules_total)

pages:
  - name: index
    components:
      - html: >-
          <p style="font-size: xx-large; font-weight: bold">
              <img src="https://sustainable-computing.io/logo.png" style="width: 80px; height: auto" />
              <span style="margin-left: 20px">Kepler Metrics</span>
          </p>
          <hr />
      - settings:
          type: METRIC
          html:
            html: >-
                <div id="${this}" class="form" style= "margin: 10px">
                    <label>Namespace</label><select id="${this}Select" class="form-control"></select>
                </div>
            javascript: >-
                namespaces = "${value}".split(", ");
                namespacesSelect = document.getElementById(${this}.id + "Select" );
                
                options = [];
                option = document.createElement("option");
                option.text = "All";
                option.value = ".*";
                option.selected = option.value === "${namespace}" ? "selected" : "";
                options.push(option);
                
                namespaces.forEach(v => {
                    var option = document.createElement("option");
                    option.text = v;
                    option.value = v;
                    option.selected = option.value === "${namespace}" ? "selected" : "";
                    options.push(option);
                });
                
                options.forEach(op => namespacesSelect.appendChild(op));
                
          lookup:
            uuid: namespaces
            group:
                - columnGroup:
                    source: timestamp
                  functions:
                    - source: container_namespace
                      function: JOIN_COMMA
      - panel: Carbon Emissions
      - panel: Pod/Service Power Consumption
      - panel: Power Consumption
      - panel: Total Power Consumption
  - name: Power Consumption
    rows:
      - properties:
          margin-top: 20px
        columns:
          - span: 6
            components:
              - settings:
                  type: timeseries
                  extraConfiguration: >-
                    {
                        "xAxis": {
                            "splitNumber": 5
                        },
                        "toolbox": {
                            "feature": {
                                "dataZoom": {},
                                "magicType": {
                                    "type": ["line", "bar", "stack"]
                                }
                            }   
                        }
                                                
                    }
                  general:
                    title: Total Power Consumption (W)
                  chart:
                    resizable: true
                    zoom: true
                    legend:
                      show: true
                  lookup:
                    uuid: totalPowerConsumptionW
                    group:
                      - functions:
                          - source: dataset
                          - source: timestamp
                          - source: value
              - properties:
                    margin-left: 50px
                    margin-right: 50px
                settings:
                  component: table
                  external:
                    height: 170px
                  table:
                    hideHeader: true
                  lookup:
                    uuid: totalPowerConsumptionW
                    group:
                      - columnGroup:
                          source: dataset
                        functions:
                          - source: dataset
                            column: ""
                          - source: value
                            function: AVERAGE
                            column: Mean
                          - source: value
                            function: AVERAGE
                            column: Max
          - span: 6
            components:
              - settings:
                  type: timeseries
                  extraConfiguration: >-
                    {
                        "xAxis": {
                            "splitNumber": 5
                        },
                        "toolbox": {
                            "feature": {
                                "dataZoom": {},
                                "magicType": {
                                    "type": ["line", "bar", "stack"]
                                }
                            }   
                        },
                        "series": [
                                { 
                                    "type": "line",
                                    "markLine": {
                                        "symbol": "none",
                                        "data": [
                                            { "type": "average"  }
                                        ]
                                    } 
                                },
                                { 
                                    "type": "line",
                                    "markLine": {
                                        "symbol": "none",
                                        "data": [
                                            { "type": "average"}
                                        ]
                                    } 
                                }
                        ]
                                                
                    }
                  general:
                    title: Total Power Consumption (kWh per day)
                  chart:
                    resizable: true
                    zoom: true
                    legend:
                      show: true
                  lookup:
                    uuid: powerConsumptionByDay
                    group:
                      - functions:
                          - source: dataset
                          - source: timestamp
                          - source: value
              - properties:
                    margin-left: 50px
                    margin-right: 50px
                settings:
                  component: table
                  external:
                    height: 170px
                  table:
                    hideHeader: true
                  lookup:
                    uuid: powerConsumptionByDay
                    group:
                      - columnGroup:
                          source: dataset
                        functions:
                          - source: dataset
                            column: ""
                          - source: value
                            function: AVERAGE
                            column: Mean
                          - source: value
                            function: AVERAGE
                            column: Max
  - name: Pod/Service Power Consumption
    rows:
      - columns:
          - properties:
                margin: 20px
            components:
              - properties:
                    width: 160px
                settings:
                    type: selector
                    filter:
                        notification: true
                    lookup:
                        uuid: byPowerConsumption
                        sort:
                            - order: ASCENDING
                              column: Pod Name
                        group:
                            - columnGroup:
                                source: Pod Name
                              functions:
                                - source: Pod Name
              - settings:
                  type: BARCHART
                  subtype: AREA_STACKED
                  extraConfiguration: >-
                    {
                        "series": [{
                            "barCategoryGap": "5%",
                            "itemStyle": {
                                "normal": {
                                    "label": {
                                        "show": true,
                                        "position": "inside",
                                        "fontSize": 9
                                        
                                    }
                                }
                            }
                        },
                        {
                            
                            "itemStyle": {
                                "normal": {
                                    "label": {
                                        "show": true,
                                        "position": "inside",
                                        "fontSize": 9
                                        
                                    }
                                }
                            }
                        }
                        ]

                    }
                  general:
                    title: Pod/Service Power Consumption
                  filter:
                        listening: true
                  axis:
                    x:
                        labels_show: false
                  chart:
                    resizable: true
                    grid:
                        x: false
                        y: false
                    legend:
                        show: true
                  lookup:
                    uuid: byPowerConsumption
                    group:
                        - columnGroup:
                            source: timestamp
                          functions:
                            - source: timestamp
                            - source: PKG
                              function: SUM
                            - source: DRAM
                              function: SUM
                            - source: OTHER
                              function: SUM
                              column: OTHER
                            - source: GPU
                              function: SUM
  - name: Total Power Consumption
    rows:
      - columns:
          - components:
              - properties:
                  margin-top: 20px
                settings:
                  type: barchart
                  general:
                    title: Total Power Consumption (PKG+DRAM) by Namespace (kWh per day)
                  extraConfiguration: >-
                    {
                        "color": ["lightgreen"],
                        "title": {
                            "left": 0
                        },
                        "series": {
                            "barCategoryGap": "1%",
                            "itemStyle": {
                                "normal": {
                                    "label": {
                                        "show": true,
                                        "position": "top",
                                        "fontSize": 25,
                                        "fontWeight": "bold",
                                        "color": "darkgreen"
                                    }
                                }
                            }
                        }

                    }
                  axis:
                    y:
                      labels_show: false
                  chart:
                    resizable: true
                    height: 380
                    grid:
                      x: false
                      y: false
                    margin:
                      top: 100
                  columns:
                    - id: value
                      expression: >-
                        new Number(value).toFixed(4)
                  lookup:
                    uuid: totalPowerConsumption
                    group:
                      - columnGroup:
                          source: container_namespace
                        groupFunctions:
                          - source: container_namespace
                          - source: value
  - name: Carbon Emissions
    properties:
      margin: 10px
    rows:
      - columns:
          - components:
              - markdown: >-
                  ##### Carbon Footprint (pounds per kWh per day) in Namespace: All (PKG+DRAM)

                  <hr />
      - properties:
          margin-left: 50px
          margin-right: 50px
        columns:
          - span: 4
            components:
              - settings:
                  type: meterchart
                  extraConfiguration: >-
                    {
                        "tooltip": {
                            "formatter": "{c}"
                        },
                        "title": {
                            "top": 160
                            
                        },
                        "series": [{
                            "detail": {
                                "show": true,
                                "formatter": "",
                                "fontSize": 10,
                                "offsetCenter": ["50%"],
                                "backgroundColor": "transparent"
                            }
                           
                        }]
                    }
                  chart:
                    resizable: true
                    height: 180
                  general:
                    title: CO2 Coal
                  lookup:
                    uuid: co2Coal
          - span: 4
            components:
              - settings:
                  type: meterchart
                  extraConfiguration: >-
                    {
                        "tooltip": {
                            "formatter": "{c}"
                        },
                        "title": {
                            "top": 160
                            
                        },
                        "series": [{
                            "detail": {
                                "show": true,
                                "formatter": "",
                                "fontSize": 10,
                                "offsetCenter": ["50%"],
                                "backgroundColor": "transparent"
                            }
                           
                        }]
                    }
                  chart:
                    resizable: true
                    height: 180
                  general:
                    title: CO2 Petroleum
                  lookup:
                    uuid: co2Petroleum
          - span: 4
            components:
              - settings:
                  type: meterchart
                  extraConfiguration: >-
                    {
                        "tooltip": {
                            "formatter": "{c}"
                        },
                        "title": {
                            "top": 160
                            
                        },
                        "series": [{
                            "detail": {
                                "show": true,
                                "formatter": "",
                                "fontSize": 10,
                                "offsetCenter": ["50%"],
                                "backgroundColor": "transparent"
                            }
                           
                        }]
                    }
                  chart:
                    resizable: true
                    height: 180
                  general:
                    title: CO2 Natural Gas
                  lookup:
                    uuid: co2NaturalGas
